# Romashka

## Документация

Схема взаимодействия сервисов и схема баз данных находятся в [доске в Miro](https://miro.com/app/board/uXjVIG6AxXs=/?share_link_id=827728461258)

### SwaggerUI

```
http://localhost:8083/swagger-ui/index.html
```

### Данные для авторизации в бд
```
url=jdbc:postgresql://localhost:54320/romashka
username=admin
password=admin
driver-class-name=org.postgresql.Driver
```


## Процесс разработки

### Планирование и организация
- **Начальное планирование**:  
  На первом созвоне с командой была создана [доска в Miro](https://miro.com/app/board/uXjVIG6AxXs=/?share_link_id=827728461258) для проектирования архитектуры системы.  

- **Трекинг задач**:  
  Создана команда на GitHub с канбан-доской для отслеживания прогресса.  

- **Командная работа**:  
  Регулярные созвоны 3 раза в неделю для обсуждения прогресса и блокеров.  

- **Автоматизация**:  
  Настроен GitHub Actions workflow для:  
  - Проверки сборки кода на PR.  
  - Запуска статического анализатора SonarQube.  

---

## CDR

### Base URL

```
http://localhost:8080
```

### API Endpoints
| Метод | Путь                          | Описание                          |
|-------|-------------------------------|-----------------------------------|
| POST  | `/api/cdr/generate/year/{n}`  | Генерация записей за `n` лет.     |
| POST  | `/api/cdr/generate/month/{n}` | Генерация записей за `n` месяцев. |
| POST  | `/api/cdr/generate/week/{n}`  | Генерация записей за `n` недель.  |
| POST  | `/api/cdr/generate/day/{n}`   | Генерация записей за `n` дней.    |
| GET   | `/health`                     | Проверка состояния сервиса.       |


### Детали реализации
- **Генерация начинается за год до текущей даты**
- **Асинхронная генерация**:  
  Используется пул потоков. Каждый поток создаёт записи о звонках с проверкой на пересечение по времени.  
- **Формат CSV**:  
  После генерации записи сортируются, пакуются в файлы по 10 записей и отправляются в RabbitMQ.  
  Пример записи:  

```csv
"call_type","caller_msisdn","receiver_msisdn","start_time","end_time"
"02","79995556688","79995556688","2024-11-12T02:17:47","2024-11-12T02:41:47"
```

- **Конфигурация RabbitMQ**:  
  Настройки очереди задаются в `infrastructure/rabbitmq/definitions.json`.  

---

## BRT

### Base URL

```
http://localhost:8081
```

### Обработка CDR

1. **Парсинг CSV из очереди**:  
   - Проверка на дубликаты.  
   - Валидация формата данных.  
2. **Проверка номера**:  
   - Если номер `caller_msisdn` не обслуживается, звонок игнорируется.  
3. **Запрос в HRS**:  
   - Отправка данных о звонке для расчёта стоимости.
4. **Обновление данных о пользователе** 

### Взаимодействие с HRS

BRT и HRS связаны между собой по REST

Пример запроса:

```json
{
   "callType": "string",
   "caller": {
      "id": 0,
      "msisdn": "string",
      "isServiced": true,
      "tariffId": 0,
      "minutes": 0,
      "paymentDay": "2025-01-01"
   },
   "receiver": {
      "id": 0,
      "msisdn": "string",
      "isServiced": true,
      "tariffId": 0,
      "minutes": 0,
      "paymentDay": "2025-01-01"
   },
   "durationMinutes": 0,
   "currentDate": "2025-01-01"
}
```

---

## HRS

### Base URL

```
http://localhost:8082
```

### Тарифы

1. **Интервальные**: Только оплаченные минуты.
2. **Поминутные**: Оплата за каждую минуту ("Классика").
3. **Смешанные**: Оплаченные минуты + доп. плата после их исчерпания ("Помесячный").

Сервис всегда сначала будет списывать уже оплаченные минуты, если они имеются, даже если тип тарифа - поминутный.
Предполагается, что такие минуты могут быть выданы в качестве, например, бонуса за подключение.

### Типы звонков
| Тип | Описание                      | 
|-----|-------------------------------|
| 1   | Исходящий абоненту Ромашки    |
| 2   | Исходящий другому оператору   |
| 3   | Входящий от абонента Ромашки  |
| 4   | Входящий от другого оператора |

Для каждого тарифа в базе данных указаны стоимости для всех 4 типов.
Разделение сделано для того, чтобы была возможность иметь разную стоимость звонков для других операторов.

Также тариф может иметь различные атрибуты: минуты, смс, гигабайты

Реализована обработка только минут

### Взаимодействие с BRT

Пример ответа:

```json
{
   "success": true,
   "cost": 0.0,
   "tariffType": "string",
   "description": "string",
   "remainingMinutes": 0,
   "nextPaymentDate": "2025-01-01",
   "errorCode": "string",
   "errorMessage": "string"
}
```

---

## CRM

### Base URL
```
http://localhost:8083
```

### Эндпоинты аутентификации

#### Возвращают JWT-токен

#### Регистрация пользователя  
```
POST /api/auth/sign-up
```
Тело запроса (SignUpRequest) для менеджера:
```json
{
  "username": "Vladimir",
  "email": "vladimir@example.com",
  "msisdn": "79994446688",
  "password": "password",
  "role": "MANAGER"
}
```
Тело запроса (SignUpRequest) для абонента
```json
{
  "username": "Alexander",
  "email": "alexander@example.com",
  "msisdn": "79995557799",
  "password": "password",
  "role": "SUBSCRIBER"
}
```
Валидация:
- Имя пользователя: обязательно, не пустое
- Email: обязательно, валидный формат (5-255 символов)
- Номер телефона: обязательно, российский формат (^[7-8]\d{10}$)
- Пароль: максимум 255 символов
- Роль: обязательно (MANAGER или SUBSCRIBER)

#### Авторизация
```
POST /api/auth/sign-in
```
Тело запроса (SignInRequest) для менеджера:
```json
{
  "username": "Vladimir",
  "password": "password"
}
```
Тело запроса (SignInRequest) для абонента:
```json
{
  "username": "Alexander",
  "password": "password"
}
```
Валидация:
- Имя пользователя: обязательно, не пустое
- Пароль: обязательно, 8-255 символов

### Authentication
Все запросы требуют JWT токена с ролю MANAGER / SUBSCRIBER в заголовке:
```
Authorization: Bearer <token>
```

### Manager Endpoints

#### 1. Управление абонентами

##### Создать абонента
```
POST /api/manager/subscriber/create
```
Тело запроса:
```json
{
  "name": "string",
  "msisdn": "79995557799",
  "tariffId": 11,
  "balance": 50.0,
  "minutes": 100,
  "paymentDay": "2025-01-01"
}
```
Обязательные поля:
- `name` - имя абонента
- `msisdn` - номер телефона (11 цифр, начинается с 7 или 8)
- `tariffId` - ID тарифного плана

Опциональные поля:
- `balance` - начальный баланс (по умолчанию: 100.0)
- `minutes` - доступные минуты (по умолчанию: 0)
- `paymentDay` - дата следующего платежа (по умолчанию: текущая дата + 1 месяц)

#### Пополнить баланс
```
POST /api/manager/subscriber/balance/top-up
```
Тело запроса:
```json
{
  "msisdn": 79995557799
  "amount": 100.0
}
```

#### Сменить тариф
```
POST /api/manager/subscriber/{msisdn}/tariff/change-tariff
```

Тело запроса:
```json
{
  "tariffId": 12
}
```

#### Получить информацию об абоненте
```
GET /api/manager/subscriber/{msisdn}
```

### 2. Управление тарифами

#### Получить детали тарифа
```
GET /api/manager/tariffs/{tariffId}
```

#### Получить все тарифы
```
GET /api/manager/tariffs?sortBy=name
```

## Subscriber Endpoints

### Пополнить баланс
```
POST /api/user/subscriber/balance/top-up
```
Тело запроса:
```json
{
  "msisdn": "79991234567",
  "amount": 100.0
}
```

## Ответы на ошибки

| Код | Описание |
|-----|----------|
| 400 | Невалидные входные данные |
| 403 | Доступ запрещен |
| 404 | Ресурс не найден |
| 500 | Внутренняя ошибка сервера |

## Docker

Для запуска:

```
docker-compose up -d --build
```

Для остановки

```
docker-compose down -v
```

## 

### Недостатки и улучшения
1. Структура таблиц и сервиса HRS позволяют добавить обработку СМС и интернет-трафика
