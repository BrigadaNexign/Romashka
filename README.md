# Romashka

## Процесс разработки
 - На первом созвоне с командой была создана доска в Miro: https://miro.com/app/board/uXjVIG6AxXs=/?share_link_id=827728461258
   Она использовалась для первоначального планирования архитектуры системы
 - Так же была создана и команда на GitHub с канбан доской для отслеживания прогресса по задачам
 - Несколько раз в неделю проводились созвоны с командой для обсуждения прогресса
 - Был создан workflow для проверки того, что код на PR может собраться без ошибок
 - После лекции по CI/CD добавил в workflow статический анализатор кода SonarQube

## CDR

### Base URL

```
http://localhost:8083
```

Описание API:
- Создание записей для указанного количества лет:
POST /api/cdr/generate/year/2
- Создание записей для указанного количества месяцев:
POST /api/cdr/generate/month/6
- Создание записей для указанного количества недель:
POST /api/cdr/generate/week/3
- Создание записей для определённого отрезка времени:
POST /api/cdr/generate/custom?start=2023-01-01T00:00&end=2023-06-01T00:00
- Проверка состояния сервиса
GET /health

Асинхронная генерация реализована через пулл потоков. Каждый поток создаёт по записи о звонке. 
Записи проверяются на пересечение.
После окончания генерации все записи о звонках сортируются, 
пачками по 10 штук собираются в CDR файлы в формате CSV и отправляются в очередь RabbitMQ. 
RabbitMq конфигурируется через definitions.json, который находится по пути infrastructure/rabbitmq/definitions.json

## Структура таблиц

## BRT

CSV, которые забирает из очереди BRT, парсятся и для каждого звонка выполняется проверка на то, не обрабатывался ли такой
же звонок до этого во избежание лишних списаний. Также для каждого звонка проверяется, обслуживается ли номер, 
который идёт первым в записи из CDR. Если да, то выполняется запрос в HRS, обрабатывается, данные обновляются, 
иначе начинается обработка следующего звонка.

BRT и HRS связаны между собой по REST

Тело запроса:

Тело ответа:

## HRS

Тарифы поделены на 3 типа: 
1. Интервальные - можно использовать только уже оплаченные минуты
2. Поминутные - плата за минуты общения - Классика
3. Смешанные - платы за дополнительные минуты взимается после истечения оплаченных - Помесячный

Сервис всегда сначала будет списывать уже оплаченные минуты, если они имеются, даже если тип тарифа - поминутный.
Предполагается, что такие минуты могут быть выданы в качестве, например, бонуса за подключение.

Все звонки делятся на 4 типа:
1. Исходящий абоненту Ромашки
2. Исходящий другому абоненту
3. Входящий от абонента Ромашки
4. Входящий от другого абонента

Для каждого тарифа в базе данных указаны стоимости для всех 4 типов.
Разделение сделано для того, чтобы была возможность иметь разную стоимость звонков для других операторов.

Также тариф может иметь различные атрибуты: минуты, смс, гигабайты 

Реализована обработка только минут

## CRM

### Base URL
```
http://localhost:8083
```

### SwaggerUI

```
http://localhost:8083/swagger-ui/index.html
```

### Эндпоинты аутентификации

#### Возвращают JWT-токен

#### Регистрация пользователя
```
POST /api/auth/sign-up
```
Тело запроса (SignUpRequest):
```json
{
  "username": "String",
  "email": "user@example.com",
  "msisdn": "79992224466",
  "password": "String",
  "role": "MANAGER|SUBSCRIBER"
}
```
Валидация:
- Имя пользователя: обязательно, не пустое
- Email: обязательно, валидный формат (5-255 символов)
- Номер телефона: обязательно, российский формат (^[7-8]\d{10}$)
- Пароль: максимум 255 символов
- Роль: обязательно (MANAGER или SUBSCRIBER)

#### Авторизация
```
POST /api/auth/sign-in
```
Тело запроса (SignInRequest):
```json
{
  "username": "String",
  "password": "String"
}
```
Валидация:
- Имя пользователя: обязательно, не пустое
- Пароль: обязательно, 8-255 символов

### Authentication
Все запросы требуют JWT токена с ролю MANAGER / SUBSCRIBER в заголовке:
```
Authorization: Bearer <token>
```

### Manager Endpoints

#### 1. Управление абонентами

##### Создать абонента
```
POST /api/manager/subscriber/create
```
Тело запроса:
```json
{
  "name": "string",
  "msisdn": "79991234567",
  "tariffId": 11,
  "balance": 100.0,
  "minutes": 100,
  "paymentDay": "2025-01-01"
}
```
Обязательные поля:
- `name` - имя абонента
- `msisdn` - номер телефона (11 цифр, начинается с 7 или 8)
- `tariffId` - ID тарифного плана

Опциональные поля:
- `balance` - начальный баланс (по умолчанию: 100.0)
- `minutes` - доступные минуты (по умолчанию: 0)
- `paymentDay` - дата следующего платежа (по умолчанию: текущая дата + 1 месяц)

#### Пополнить баланс
```
POST /api/manager/subscriber/{msisdn}/balance/top-up
```
Тело запроса:
```json
{
  "amount": 100.0
}
```

#### Сменить тариф
```
POST /api/manager/subscriber/{msisdn}/tariff/change-tariff
```
Тело запроса:
```json
{
  "tariffId": 12
}
```

#### Получить информацию об абоненте
```
GET /api/manager/subscriber/{msisdn}
```

### 2. Управление тарифами

#### Получить детали тарифа
```
GET /api/manager/tariffs/{tariffId}
```

#### Получить все тарифы
```
GET /api/manager/tariffs?sortBy=name
```

## Subscriber Endpoints

### Пополнить баланс
```
POST /api/user/subscriber/balance/top-up
```
Тело запроса:
```json
{
  "msisdn": "79991234567",
  "amount": 100.0
}
```

## Ответы на ошибки

| Код | Описание |
|-----|----------|
| 400 | Невалидные входные данные |
| 403 | Доступ запрещен |
| 404 | Ресурс не найден |
| 500 | Внутренняя ошибка сервера |

## Docker

Для запуска:

```
docker-compose build
```

```
docker-compose up -d
```

Для остановки

```
docker-compose down -v
```
